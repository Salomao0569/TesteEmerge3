function calcularMassaVE(){const DDVE=Number(document.getElementById('diam_diast_final').value);const PPVE=Number(document.getElementById('esp_diast_ppve').value);const SIV=Number(document.getElementById('esp_diast_septo').value);if(DDVE>0&&PPVE>0&&SIV>0){const DDVEcm=DDVE/10;const PPVEcm=PPVE/10;const SIVcm=SIV/10;return Math.round(0.8*(1.04*Math.pow((DDVEcm+PPVEcm+SIVcm),3)-Math.pow(DDVEcm,3))+0.6);}
return 0;}
function setElementText(element,text){if(element){element.textContent=text;}}
function setElementValue(element,value){if(element){element.value=value;}}
function getElementValue(element){return element?(parseFloat(element.value)||0):0;}
function calcularSuperficieCorporea(peso,altura){return Math.round((0.007184*Math.pow(peso,0.425)*Math.pow(altura,0.725))*100)/100;}
function classificarAtrioEsquerdo(valor,sexo){if(!valor||!sexo)return{texto:'',nivel:'normal'};let classificacao={texto:'',nivel:'normal'};if(sexo==='M'){if(valor<=40){classificacao.texto='normal';classificacao.nivel='normal';}else if(valor>40&&valor<=44){classificacao.texto='levemente aumentado';classificacao.nivel='mild';}else if(valor>44&&valor<=48){classificacao.texto='moderadamente aumentado';classificacao.nivel='moderate';}else{classificacao.texto='gravemente aumentado';classificacao.nivel='severe';}}else if(sexo==='F'){if(valor<=38){classificacao.texto='normal';classificacao.nivel='normal';}else if(valor>38&&valor<=42){classificacao.texto='levemente aumentado';classificacao.nivel='mild';}else if(valor>42&&valor<=46){classificacao.texto='moderadamente aumentado';classificacao.nivel='moderate';}else{classificacao.texto='gravemente aumentado';classificacao.nivel='severe';}}
return classificacao;}
function atualizarClassificacao(elemento,texto,nivel){if(!elemento)return;elemento.textContent=texto;elemento.className='alert '+nivel;}
function obterNivelClassificacao(texto){if(texto.includes('normal'))return'normal';if(texto.includes('levemente')||texto.includes('discretamente'))return'mild';if(texto.includes('moderadamente'))return'moderate';if(texto.includes('gravemente')||texto.includes('importante'))return'severe';return'normal';}
function calcularVolumeDiastolicoFinal(diametro){const diametroCm=diametro/10;return Math.round((7/(2.4+diametroCm))*Math.pow(diametroCm,3));}
function calcularVolumeSistolicoFinal(diametro){const diametroCm=diametro/10;return Math.round((7/(2.4+diametroCm))*Math.pow(diametroCm,3));}
function classificarAorta(valor,sexo,segmento){if(!valor||!sexo||!segmento)return{texto:'',nivel:'normal'};const referencias={'M':{'anel':{normal:[23,29],discreto:[30,33],moderado:[34,37],importante:37},'raiz':{normal:[31,37],discreto:[37,40],moderado:[40,43],importante:44},'juncao':{normal:[26,32],discreto:[33,36],moderado:[36,39],importante:40},'ascendente':{normal:[26,34],discreto:[35,39],moderado:[40,43],importante:44}},'F':{'anel':{normal:[21,25],discreto:[26,29],moderado:[29,32],importante:32},'raiz':{normal:[27,33],discreto:[34,37],moderado:[37,40],importante:40},'juncao':{normal:[23,29],discreto:[30,33],moderado:[34,37],importante:38},'ascendente':{normal:[23,31],discreto:[32,36],moderado:[37,41],importante:42}}};const ref=referencias[sexo][segmento];if(!ref)return{texto:'',nivel:'normal'};let classificacao={texto:'',nivel:'normal'};if(valor<=ref.normal[1]){classificacao.texto='normal';classificacao.nivel='normal';}else if(valor<=ref.discreto[1]){classificacao.texto='discretamente dilatada';classificacao.nivel='mild';}else if(valor<=ref.moderado[1]){classificacao.texto='moderadamente dilatada';classificacao.nivel='moderate';}else if(valor>ref.importante){classificacao.texto='importante dilatação';classificacao.nivel='severe';}
const segmentoNomes={'anel':'Anel aórtico','raiz':'Raiz da aorta','juncao':'Junção sinotubular','ascendente':'Aorta ascendente'};return classificacao.texto?{texto:`${segmentoNomes[segmento]}${classificacao.texto}.`,nivel:classificacao.nivel}:{texto:'',nivel:'normal'};}
function classificarSeptoEParede(valor,sexo){if(!valor||!sexo)return{texto:'',nivel:'normal'};let classificacao={texto:'',nivel:'normal'};if(sexo==='F'){if(valor>=6&&valor<=10){classificacao.texto='normal';classificacao.nivel='normal';}else if(valor>=11&&valor<=13){classificacao.texto='discretamente aumentado';classificacao.nivel='mild';}else if(valor>=14&&valor<=16){classificacao.texto='moderadamente aumentado';classificacao.nivel='moderate';}else if(valor>16){classificacao.texto='gravemente aumentado';classificacao.nivel='severe';}}else if(sexo==='M'){if(valor>=6&&valor<=11){classificacao.texto='normal';classificacao.nivel='normal';}else if(valor>=12&&valor<=14){classificacao.texto='discretamente aumentado';classificacao.nivel='mild';}else if(valor>=15&&valor<=17){classificacao.texto='moderadamente aumentado';classificacao.nivel='moderate';}else if(valor>17){classificacao.texto='gravemente aumentado';classificacao.nivel='severe';}}
return classificacao;}
function classificarDiametroVE(valor,sexo,tipo){if(!valor||!sexo||!tipo)return{texto:'',nivel:'normal'};const referencias={'M':{'diastolico':{normal:[42,58],discreto:[59,63],moderado:[64,68],importante:68},'sistolico':{normal:[25,40],discreto:[41,43],moderado:[44,45],importante:45}},'F':{'diastolico':{normal:[38,52],discreto:[53,56],moderado:[57,61],importante:61},'sistolico':{normal:[22,35],discreto:[36,38],moderado:[39,41],importante:41}}};const ref=referencias[sexo][tipo];if(!ref)return{texto:'',nivel:'normal'};let classificacao={texto:'',nivel:'normal'};if(valor>=ref.normal[0]&&valor<=ref.normal[1]){classificacao.texto='normal';classificacao.nivel='normal';}else if(valor>=ref.discreto[0]&&valor<=ref.discreto[1]){classificacao.texto='discretamente aumentado';classificacao.nivel='mild';}else if(valor>=ref.moderado[0]&&valor<=ref.moderado[1]){classificacao.texto='moderadamente aumentado';classificacao.nivel='moderate';}else if(valor>ref.importante){classificacao.texto='importante aumento';classificacao.nivel='severe';}else if(valor<ref.normal[0]){classificacao.texto='reduzido';classificacao.nivel='severe';}
const tipoNome=tipo==='diastolico'?'diastólico':'sistólico';return{texto:classificacao.texto?`Diâmetro ${tipoNome}do VE ${classificacao.texto}.`:'',nivel:classificacao.nivel};}
function classificarEspessuraRelativa(espessuraRelativa,massaVE,sexo){if(!espessuraRelativa||!massaVE||!sexo)return{texto:'',nivel:'normal'};const limiteMassa={'M':115,'F':95};const massaAumentada=massaVE>limiteMassa[sexo];let classificacao={texto:'',nivel:'moderate'};if(espessuraRelativa<0.42){if(massaAumentada){classificacao.texto='Hipertrofia excêntrica do VE.';}else{classificacao.texto='Geometria normal do VE.';classificacao.nivel='normal';}}else{if(massaAumentada){classificacao.texto='Hipertrofia concêntrica do VE.';}else{classificacao.texto='Remodelamento concêntrico do VE.';}}
return classificacao;}
function calcularResultados(){const elementos={peso:document.getElementById('peso'),altura:document.getElementById('altura'),atrio:document.getElementById('atrio'),diamDiastFinal:document.getElementById('diam_diast_final'),diamSistFinal:document.getElementById('diam_sist_final'),espDiastSepto:document.getElementById('esp_diast_septo'),espDiastPPVE:document.getElementById('esp_diast_ppve'),superficie:document.getElementById('superficie'),printVolumeDiastFinal:document.getElementById('print_volume_diast_final'),printVolumeSistFinal:document.getElementById('print_volume_sist_final'),printVolumeEjetado:document.getElementById('print_volume_ejetado'),printFracaoEjecao:document.getElementById('print_fracao_ejecao'),printPercentEncurt:document.getElementById('print_percent_encurt'),printEspRelativa:document.getElementById('print_esp_relativa'),printMassaVE:document.getElementById('print_massa_ve'),printIndiceMassa:document.getElementById('print_indice_massa'),classificacaoFe:document.getElementById('classificacao_fe'),classificacaoAe:document.getElementById('classificacao_ae'),sexo:document.getElementById('sexo'),aorta:document.getElementById('aorta'),aortaAsc:document.getElementById('aorta_ascendente'),classificacaoAorta:document.getElementById('classificacao_aorta'),classificacaoAortaAsc:document.getElementById('classificacao_aorta_ascendente'),classificacaoSepto:document.getElementById('classificacao_septo'),classificacaoPPVE:document.getElementById('classificacao_ppve'),classificacaoDiastolico:document.getElementById('classificacao_diastolico'),classificacaoSistolico:document.getElementById('classificacao_sistolico'),classificacaoEspessura:document.getElementById('classificacao_espessura')};if(!elementos.diamDiastFinal||!elementos.diamSistFinal){console.error('Elementos essenciais não encontrados');return;}
const peso=getElementValue(elementos.peso);const altura=getElementValue(elementos.altura);const atrio=getElementValue(elementos.atrio);const diamDiastFinal=getElementValue(elementos.diamDiastFinal);const diamSistFinal=getElementValue(elementos.diamSistFinal);const espDiastSepto=getElementValue(elementos.espDiastSepto);const espDiastPPVE=getElementValue(elementos.espDiastPPVE);const aorta=getElementValue(elementos.aorta);const aortaAsc=getElementValue(elementos.aortaAsc);if(atrio>0&&elementos.classificacaoAe&&elementos.sexo){const resultado=classificarAtrioEsquerdo(atrio,elementos.sexo.value);atualizarClassificacao(elementos.classificacaoAe,`Átrio esquerdo ${resultado.texto}.`,resultado.nivel);}
if(peso>0&&altura>0){const superficie=calcularSuperficieCorporea(peso,altura);setElementValue(elementos.superficie,superficie.toFixed(2));}
let volumeDiastFinal=0;if(diamDiastFinal>0){volumeDiastFinal=calcularVolumeDiastolicoFinal(diamDiastFinal);setElementText(elementos.printVolumeDiastFinal,`${volumeDiastFinal}mL`);}
let volumeSistFinal=0;if(diamSistFinal>0){volumeSistFinal=calcularVolumeSistolicoFinal(diamSistFinal);setElementText(elementos.printVolumeSistFinal,`${volumeSistFinal}mL`);}
if(volumeDiastFinal>0&&volumeSistFinal>0){const volumeEjetado=volumeDiastFinal-volumeSistFinal;setElementText(elementos.printVolumeEjetado,`${volumeEjetado}mL`);const fracaoEjecao=Math.round((volumeEjetado/volumeDiastFinal)*100);setElementText(elementos.printFracaoEjecao,`${fracaoEjecao}%`);if(elementos.classificacaoFe&&elementos.sexo){const sexo=elementos.sexo.value;let classificacao={texto:'',nivel:'normal'};if(sexo==='M'){if(fracaoEjecao>=52&&fracaoEjecao<=72){classificacao.texto='normal';classificacao.nivel='normal';}else if(fracaoEjecao>72){classificacao.texto='aumentada';classificacao.nivel='normal';}else if(fracaoEjecao>=41&&fracaoEjecao<52){classificacao.texto='disfunção discreta';classificacao.nivel='mild';}else if(fracaoEjecao>=30&&fracaoEjecao<41){classificacao.texto='disfunção moderada';classificacao.nivel='moderate';}else if(fracaoEjecao<30){classificacao.texto='disfunção grave';classificacao.nivel='severe';}}else if(sexo==='F'){if(fracaoEjecao>=54&&fracaoEjecao<=74){classificacao.texto='normal';classificacao.nivel='normal';}else if(fracaoEjecao>74){classificacao.texto='aumentada';classificacao.nivel='normal';}else if(fracaoEjecao>=41&&fracaoEjecao<54){classificacao.texto='disfunção discreta';classificacao.nivel='mild';}else if(fracaoEjecao>=30&&fracaoEjecao<41){classificacao.texto='disfunção moderada';classificacao.nivel='moderate';}else if(fracaoEjecao<30){classificacao.texto='disfunção grave';classificacao.nivel='severe';}}
if(classificacao.texto){atualizarClassificacao(elementos.classificacaoFe,`Fração de ejeção do ventrículo esquerdo ${classificacao.texto}.`,classificacao.nivel);}}}
if(diamDiastFinal>0&&diamSistFinal>0){const percentEncurt=Math.round(((diamDiastFinal-diamSistFinal)/diamDiastFinal)*100);setElementText(elementos.printPercentEncurt,`${percentEncurt}%`);}
if(diamDiastFinal>0&&espDiastPPVE>0){const espessuraRelativa=Math.round((2*espDiastPPVE/diamDiastFinal)*100)/100;setElementText(elementos.printEspRelativa,espessuraRelativa.toFixed(2));if(elementos.classificacaoEspessura&&elementos.sexo){const superficie=parseFloat(elementos.superficie?.value||0);const massaVE=calcularMassaVE();const indiceMassa=superficie>0?Math.round((massaVE/superficie)*10)/10:0;const resultado=classificarEspessuraRelativa(espessuraRelativa,indiceMassa,elementos.sexo.value);atualizarClassificacao(elementos.classificacaoEspessura,resultado.texto,resultado.nivel);}}
const massaVE=calcularMassaVE();if(massaVE>0){setElementText(elementos.printMassaVE,`${massaVE}g`);const superficie=parseFloat(elementos.superficie?.value||0);if(superficie>0){const indiceMassa=Math.round((massaVE/superficie)*10)/10;setElementText(elementos.printIndiceMassa,`${indiceMassa}g/m²`);}}
if(aorta>0&&elementos.classificacaoAorta&&elementos.sexo){const resultado=classificarAorta(aorta,elementos.sexo.value,'raiz');atualizarClassificacao(elementos.classificacaoAorta,resultado.texto,resultado.nivel);}
if(aortaAsc>0&&elementos.classificacaoAortaAsc&&elementos.sexo){const resultado=classificarAorta(aortaAsc,elementos.sexo.value,'ascendente');atualizarClassificacao(elementos.classificacaoAortaAsc,resultado.texto,resultado.nivel);}
if(espDiastSepto>0&&elementos.classificacaoSepto&&elementos.sexo){const resultado=classificarSeptoEParede(espDiastSepto,elementos.sexo.value);atualizarClassificacao(elementos.classificacaoSepto,`Septo interventricular ${resultado.texto}.`,resultado.nivel);}
if(espDiastPPVE>0&&elementos.classificacaoPPVE&&elementos.sexo){const resultado=classificarSeptoEParede(espDiastPPVE,elementos.sexo.value);atualizarClassificacao(elementos.classificacaoPPVE,`Parede posterior do VE ${resultado.texto}.`,resultado.nivel);}
if(diamDiastFinal>0&&elementos.classificacaoDiastolico&&elementos.sexo){const resultado=classificarDiametroVE(diamDiastFinal,elementos.sexo.value,'diastolico');atualizarClassificacao(elementos.classificacaoDiastolico,resultado.texto,resultado.nivel);}
if(diamSistFinal>0&&elementos.classificacaoSistolico&&elementos.sexo){const resultado=classificarDiametroVE(diamSistFinal,elementos.sexo.value,'sistolico');atualizarClassificacao(elementos.classificacaoSistolico,resultado.texto,resultado.nivel);}}
function destacarValorAlterado(elemento){if(!elemento)return;const parentCell=elemento.parentElement;const alertDiv=parentCell.querySelector('.alert');if(alertDiv){alertDiv.classList.add('alert-value');setTimeout(()=>{alertDiv.classList.remove('alert-value');},2000);}}
document.addEventListener('DOMContentLoaded',function(){const inputs=document.querySelectorAll('input[type="number"]');const sexoSelect=document.getElementById('sexo');if(inputs.length>0&&sexoSelect){inputs.forEach(input=>{input.addEventListener('input',function(event){destacarValorAlterado(event.target);calcularResultados();});});sexoSelect.addEventListener('change',calcularResultados);}else{console.error('Elementos necessários não encontrados durante a inicialização');}});function getCSRFToken(){try{const metaToken=document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');if(metaToken)return metaToken;const inputToken=document.querySelector('input[name="csrf_token"]')?.value;if(inputToken)return inputToken;console.error('CSRF token não encontrado');return null;}catch(error){console.error('Erro ao obter CSRF token:',error);return null;}}
function addCSRFToken(headers={}){const token=getCSRFToken();if(!token){console.error('Token CSRF não disponível');return headers;}
return{...headers,'X-CSRFToken':token};}
$(document).ready(function(){try{const token=getCSRFToken();if(token){$.ajaxSetup({beforeSend:function(xhr){xhr.setRequestHeader('X-CSRFToken',token);}});}else{console.error('Não foi possível configurar o token CSRF para requisições AJAX');}}catch(error){console.error('Erro ao configurar CSRF token:',error);}});function updateCSRFToken(){try{const token=getCSRFToken();if(token){let metaTag=document.querySelector('meta[name="csrf-token"]');if(!metaTag){metaTag=document.createElement('meta');metaTag.name='csrf-token';document.head.appendChild(metaTag);}
metaTag.content=token;let inputField=document.querySelector('input[name="csrf_token"]');if(!inputField){inputField=document.createElement('input');inputField.type='hidden';inputField.name='csrf_token';document.body.appendChild(inputField);}
inputField.value=token;}}catch(error){console.error('Erro ao atualizar CSRF token:',error);}}
document.addEventListener('DOMContentLoaded',updateCSRFToken);function gerarDOC(){try{console.log('Iniciando geração do DOC...');const paciente={nome:document.getElementById('nome').value||'N/D',dataNascimento:document.getElementById('dataNascimento').value||'N/D',sexo:document.getElementById('sexo').value||'N/D',peso:document.getElementById('peso').value?`${document.getElementById('peso').value}kg`:'N/D',altura:document.getElementById('altura').value?`${document.getElementById('altura').value}cm`:'N/D',dataExame:document.getElementById('dataExame').value||new Date().toLocaleDateString('pt-BR')};console.log('Dados do paciente:',paciente);const doctorSelect=document.getElementById('selectedDoctor');const doctorData=doctorSelect.value?{nome:doctorSelect.options[doctorSelect.selectedIndex].text,crm:doctorSelect.options[doctorSelect.selectedIndex].dataset.crm,rqe:doctorSelect.options[doctorSelect.selectedIndex].dataset.rqe}:null;console.log('Dados do médico:',doctorData);const laudoContent=$('#editor').summernote('code');console.log('Conteúdo do editor recuperado');const metaTag=document.querySelector('meta[name="csrf-token"]');if(!metaTag){throw new Error('Meta tag CSRF não encontrada');}
const data={paciente:paciente,medidas:{atrio:document.getElementById('atrio').value||'N/D',aorta:document.getElementById('aorta').value||'N/D',diamDiastFinal:document.getElementById('diam_diast_final').value||'N/D',diamSistFinal:document.getElementById('diam_sist_final').value||'N/D',espDiastSepto:document.getElementById('esp_diast_septo').value||'N/D',espDiastPPVE:document.getElementById('esp_diast_ppve').value||'N/D',vd:document.getElementById('vd').value||'N/D'},calculos:{volumeDiastFinal:document.getElementById('print_volume_diast_final').textContent,volumeSistFinal:document.getElementById('print_volume_sist_final').textContent,volumeEjetado:document.getElementById('print_volume_ejetado').textContent,fracaoEjecao:document.getElementById('print_fracao_ejecao').textContent,percentEncurt:document.getElementById('print_percent_encurt').textContent,espRelativa:document.getElementById('print_esp_relativa').textContent,massaVE:document.getElementById('print_massa_ve').textContent},laudo:laudoContent,medico:doctorData};console.log('Dados preparados para envio:',data);fetch('/gerar_doc',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':metaTag.getAttribute('content')},body:JSON.stringify(data)}).then(response=>{console.log('Resposta recebida:',response);if(!response.ok){if(response.headers.get('content-type')?.includes('application/json')){return response.json().then(error=>{throw new Error(error.error||'Erro ao gerar o documento');});}
throw new Error('Erro ao gerar o documento');}
return response.blob();}).then(blob=>{console.log('Blob recebido:',blob);if(!blob){throw new Error('Documento gerado está vazio');}
const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`Laudo_${paciente.nome.replace(/[^a-zA-Z0-9]/g,'_')}.docx`;document.body.appendChild(a);a.click();window.URL.revokeObjectURL(url);a.remove();console.log('Download iniciado');}).catch(error=>{console.error('Erro ao gerar DOC:',error);alert('Erro ao gerar o documento DOC: '+error.message);});}catch(error){console.error('Erro ao preparar dados:',error);alert('Erro ao preparar dados para geração do documento: '+error.message);}}
function getCSRFToken(){const name='csrf_token=';const decodedCookie=decodeURIComponent(document.cookie);const cookieArray=decodedCookie.split(';');for(let cookie of cookieArray){while(cookie.charAt(0)===' '){cookie=cookie.substring(1);}
if(cookie.indexOf(name)===0){return cookie.substring(name.length,cookie.length);}}
return'';}
function addCSRFToken(headers={}){const token=document.querySelector('meta[name="csrf-token"]').getAttribute('content');return{...headers,'X-CSRFToken':token};}
async function loadDoctors(){try{const response=await fetch('/api/doctors');if(!response.ok){throw new Error('Erro ao carregar médicos');}
const doctors=await response.json();updateDoctorsTable(doctors);updateDoctorsSelect(doctors);}catch(error){showFeedback('Erro ao carregar médicos: '+error.message,'danger');}}
function updateDoctorsTable(doctors){const tbody=document.querySelector('#doctorsTable tbody');if(!tbody)return;tbody.innerHTML=doctors.map(doctor=>`<tr data-id="${doctor.id}"><td>${doctor.full_name}</td><td>${doctor.crm}</td><td>${doctor.rqe||'-'}</td><td><button class="btn btn-sm btn-warning me-1"onclick="editDoctor(${doctor.id})"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger"onclick="deleteDoctor(${doctor.id})"><i class="fas fa-trash"></i></button></td></tr>`).join('');}
function updateDoctorsSelect(doctors){const select=document.querySelector('#selectedDoctor');if(!select)return;select.innerHTML=`<option value="">Selecione o médico...</option>${doctors.map(doctor=>`<option value="${doctor.id}">Dr(a).${doctor.full_name}-CRM:${doctor.crm}${doctor.rqe?' RQE: '+doctor.rqe:''}</option>`).join('')}`;}
function updateSignaturePreview(){const name=document.getElementById('doctorName')?.value||'';const crm=document.getElementById('doctorCRM')?.value||'';const rqe=document.getElementById('doctorRQE')?.value||'';const preview=document.getElementById('signaturePreview');if(preview){preview.innerHTML=`<strong>Dr(a).${name||'Nome do Médico'}</strong><br>CRM:${crm||'XXXXX'}${rqe?`/RQE:${rqe}`:''}`;}}
async function saveDoctor(){const form=document.getElementById('doctorForm');if(!form)return;if(!form.checkValidity()){form.classList.add('was-validated');return;}
const doctorId=document.getElementById('doctorId')?.value;const doctorData={full_name:document.getElementById('doctorName')?.value,crm:document.getElementById('doctorCRM')?.value,rqe:document.getElementById('doctorRQE')?.value||null};try{const response=await fetch(doctorId?`/api/doctors/${doctorId}`:'/api/doctors',{method:doctorId?'PUT':'POST',headers:addCSRFToken({'Content-Type':'application/json'}),body:JSON.stringify(doctorData)});if(!response.ok){const error=await response.json();throw new Error(error.message||'Erro ao salvar médico');}
showFeedback('Médico salvo com sucesso!','success');const modal=bootstrap.Modal.getInstance(document.getElementById('doctorsModal'));modal?.hide();form.reset();form.classList.remove('was-validated');document.getElementById('doctorId').value='';await loadDoctors();}catch(error){showFeedback(error.message,'danger');}}
function editDoctor(id){const row=document.querySelector(`#doctorsTable tr[data-id="${id}"]`);if(!row)return;const cells=row.getElementsByTagName('td');document.getElementById('doctorId').value=id;document.getElementById('doctorName').value=cells[0].textContent;document.getElementById('doctorCRM').value=cells[1].textContent;document.getElementById('doctorRQE').value=cells[2].textContent!=='-'?cells[2].textContent:'';updateSignaturePreview();}
async function deleteDoctor(id){if(!confirm('Tem certeza que deseja excluir este médico?')){return;}
try{const response=await fetch(`/api/doctors/${id}`,{method:'DELETE',headers:addCSRFToken()});if(!response.ok){const error=await response.json();throw new Error(error.message||'Erro ao excluir médico');}
showFeedback('Médico excluído com sucesso!','success');await loadDoctors();}catch(error){showFeedback(error.message,'danger');}}
function showFeedback(message,type='success'){const toast=document.createElement('div');toast.className=`alert alert-${type}position-fixed bottom-0 end-0 m-3`;toast.style.zIndex='9999';toast.innerHTML=message;document.body.appendChild(toast);setTimeout(()=>toast.remove(),3000);}
document.addEventListener('DOMContentLoaded',function(){loadDoctors();const form=document.getElementById('doctorForm');if(form){['doctorName','doctorCRM','doctorRQE'].forEach(id=>{const input=document.getElementById(id);if(input){input.addEventListener('input',updateSignaturePreview);}});form.addEventListener('submit',(e)=>{e.preventDefault();saveDoctor();});}
const modal=document.getElementById('doctorsModal');if(modal){modal.addEventListener('hidden.bs.modal',function(){if(form){form.reset();form.classList.remove('was-validated');}
document.getElementById('doctorId').value='';updateSignaturePreview();});}});document.addEventListener('DOMContentLoaded',function(){if(document.getElementById('editor')){$('#editor').summernote({height:500,toolbar:[['style',['style']],['font',['bold','italic','underline','strikethrough','superscript','subscript','clear']],['fontname',['fontname']],['fontsize',['fontsize']],['color',['color']],['para',['ul','ol','paragraph']],['table',['table']],['insert',['link','hr']],['view',['fullscreen','codeview']],['custom',['templates']]],fontNames:['Arial','Times New Roman','Helvetica','Calibri'],fontSizes:['8','9','10','11','12','14','16','18','24','36'],styleTags:['p','h1','h2','h3','h4','h5','h6'],callbacks:{onChange:function(contents){localStorage.setItem('editorDraft',contents);},onInit:function(){const savedDraft=localStorage.getItem('editorDraft');if(savedDraft){$('#editor').summernote('code',savedDraft);}}}});const templatesButton=createTemplatesButton();$('.note-toolbar').append(templatesButton);}});function createTemplatesButton(){const button=$('<div class="note-btn-group btn-group note-template">');const templatesDropdown=$(`<button type="button"class="note-btn btn btn-light btn-sm dropdown-toggle"data-bs-toggle="dropdown"><i class="fas fa-file-medical"></i>Templates</button><div class="dropdown-menu"><a class="dropdown-item"href="#"data-template="normal">Laudo Normal</a><a class="dropdown-item"href="#"data-template="alterado">Laudo Alterado</a><div class="dropdown-divider"></div><a class="dropdown-item"href="#"onclick="gerenciarTemplates()">Gerenciar Templates</a></div>`);button.append(templatesDropdown);return button;}
function inserirAssinaturaMedico(){const select=document.getElementById('selectedDoctor');if(!select)return;const option=select.options[select.selectedIndex];if(!option||!option.value){alert('Por favor, selecione um médico responsável');return;}
const medicName=option.text;const crm=option.dataset.crm;const rqe=option.dataset.rqe;const dadosMedico=`<p style="text-align: center; margin-top: 30px;"><strong>Dr.${medicName}</strong><br>CRM:${crm}${rqe?`/RQE:${rqe}`:''}</p>`;const currentContent=$('#editor').summernote('code');$('#editor').summernote('code',currentContent+dadosMedico);}
function gerenciarTemplates(){window.location.href='/templates';}
function limparEditor(){if(confirm('Deseja realmente limpar todo o conteúdo do editor?')){$('#editor').summernote('code','');localStorage.removeItem('editorDraft');}}
function formatarData(input){let valor=input.value.replace(/\D/g,"");if(valor.length>2)valor=valor.replace(/^(\d{2})(\d)/,"$1/$2");if(valor.length>5)valor=valor.replace(/^(\d{2}\/\d{2})(\d)/,"$1/$2");input.value=valor;}
document.addEventListener('DOMContentLoaded',function(){const dateInput=document.getElementById('dataNascimento');if(dateInput){dateInput.addEventListener('input',function(){const examDateInput=document.getElementById('dataExame');if(examDateInput){const today=new Date();const year=today.getFullYear();const month=String(today.getMonth()+1).padStart(2,'0');const day=String(today.getDate()).padStart(2,'0');examDateInput.value=`${year}-${month}-${day}`;}
formatarData(this);});}});function validateNumericInput(input,min,max){const value=parseFloat(input.value);if(isNaN(value)){showError(input,'Valor inválido');return false;}
if(value<min||value>max){showError(input,`Valor deve estar entre ${min}e ${max}`);return false;}
removeError(input);return true;}
function showError(input,message){input.classList.add('is-invalid');const errorDiv=input.nextElementSibling||document.createElement('div');errorDiv.className='invalid-feedback';errorDiv.textContent=message;if(!input.nextElementSibling){input.parentNode.appendChild(errorDiv);}}
function removeError(input){input.classList.remove('is-invalid');const errorDiv=input.nextElementSibling;if(errorDiv&&errorDiv.className==='invalid-feedback'){errorDiv.remove();}}
document.addEventListener('DOMContentLoaded',function(){const numericInputs={'peso':{min:0.5,max:300},'altura':{min:30,max:250},'atrio':{min:10,max:100},'aorta':{min:10,max:100},'diam_diast_final':{min:10,max:100},'diam_sist_final':{min:10,max:100},'esp_diast_septo':{min:1,max:50},'esp_diast_ppve':{min:1,max:50},'vd':{min:1,max:100}};Object.entries(numericInputs).forEach(([id,limits])=>{const input=document.getElementById(id);if(input){input.addEventListener('input',()=>{validateNumericInput(input,limits.min,limits.max);});}});});function gerarPDF(){try{console.log("Iniciando geração do PDF...");const dataExame=document.getElementById('dataExame').value;const dataFormatada=dataExame?new Date(dataExame).toLocaleDateString('pt-BR'):new Date().toLocaleDateString('pt-BR');const paciente={nome:document.getElementById('nome').value||'N/D',dataNascimento:document.getElementById('dataNascimento').value||'N/D',sexo:document.getElementById('sexo').value||'N/D',peso:document.getElementById('peso').value||'N/D',altura:document.getElementById('altura').value||'N/D',dataExame:dataFormatada};console.log("Dados do paciente:",paciente);const medidas={atrio:document.getElementById('atrio').value||'N/D',aorta:document.getElementById('aorta').value||'N/D',diamDiastFinal:document.getElementById('diam_diast_final').value||'N/D',diamSistFinal:document.getElementById('diam_sist_final').value||'N/D',espDiastSepto:document.getElementById('esp_diast_septo').value||'N/D',espDiastPPVE:document.getElementById('esp_diast_ppve').value||'N/D',vd:document.getElementById('vd').value||'N/D'};const calculos={volumeDiastFinal:document.getElementById('print_volume_diast_final').textContent||'N/D',volumeSistFinal:document.getElementById('print_volume_sist_final').textContent||'N/D',volumeEjetado:document.getElementById('print_volume_ejetado').textContent||'N/D',fracaoEjecao:document.getElementById('print_fracao_ejecao').textContent||'N/D',percentEncurt:document.getElementById('print_percent_encurt').textContent||'N/D',espRelativa:document.getElementById('print_esp_relativa').textContent||'N/D',massaVE:document.getElementById('print_massa_ve').textContent||'N/D'};const doctorSelect=document.getElementById('selectedDoctor');let medico=null;if(doctorSelect&&doctorSelect.value){const selectedOption=doctorSelect.selectedOptions[0];medico={nome:selectedOption.text,crm:selectedOption.dataset.crm,rqe:selectedOption.dataset.rqe};}
console.log("Dados do médico:",medico);const editor=document.getElementById('editor');const laudo=editor?editor.innerHTML:'';console.log("Conteúdo do editor recuperado");if(!laudo){throw new Error('O conteúdo do laudo não pode estar vazio');}
const dadosLaudo={paciente,medidas,calculos,medico,laudo};fetch('/gerar_pdf',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFToken()},body:JSON.stringify(dadosLaudo)}).then(response=>{if(!response.ok){throw new Error('Erro ao gerar PDF');}
return response.blob();}).then(blob=>{const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`Laudo_${paciente.nome.trim().replace(/[^a-zA-Z0-9]/g,'_')}.pdf`;document.body.appendChild(a);a.click();window.URL.revokeObjectURL(url);a.remove();}).catch(error=>{console.error('Erro ao gerar PDF:',error);alert('Erro ao gerar o PDF. Por favor, tente novamente.');});}catch(error){console.error('Erro ao preparar dados:',error);alert('Erro ao gerar o PDF. Por favor, verifique os dados e tente novamente.');}}
function gerarDOC(){try{console.log("Iniciando geração do DOC...");const dataExame=document.getElementById('dataExame').value;const dataFormatada=dataExame?new Date(dataExame).toLocaleDateString('pt-BR'):new Date().toLocaleDateString('pt-BR');const paciente={nome:document.getElementById('nome').value||'N/D',dataNascimento:document.getElementById('dataNascimento').value||'N/D',sexo:document.getElementById('sexo').value||'N/D',peso:document.getElementById('peso').value||'N/D',altura:document.getElementById('altura').value||'N/D',dataExame:dataFormatada};console.log("Dados do paciente:",paciente);const medidas={atrio:document.getElementById('atrio').value||'N/D',aorta:document.getElementById('aorta').value||'N/D',diamDiastFinal:document.getElementById('diam_diast_final').value||'N/D',diamSistFinal:document.getElementById('diam_sist_final').value||'N/D',espDiastSepto:document.getElementById('esp_diast_septo').value||'N/D',espDiastPPVE:document.getElementById('esp_diast_ppve').value||'N/D',vd:document.getElementById('vd').value||'N/D'};const calculos={volumeDiastFinal:document.getElementById('print_volume_diast_final').textContent||'N/D',volumeSistFinal:document.getElementById('print_volume_sist_final').textContent||'N/D',volumeEjetado:document.getElementById('print_volume_ejetado').textContent||'N/D',fracaoEjecao:document.getElementById('print_fracao_ejecao').textContent||'N/D',percentEncurt:document.getElementById('print_percent_encurt').textContent||'N/D',espRelativa:document.getElementById('print_esp_relativa').textContent||'N/D',massaVE:document.getElementById('print_massa_ve').textContent||'N/D'};const doctorSelect=document.getElementById('selectedDoctor');let medico=null;if(doctorSelect&&doctorSelect.value){const selectedOption=doctorSelect.selectedOptions[0];medico={nome:selectedOption.text,crm:selectedOption.dataset.crm,rqe:selectedOption.dataset.rqe};}
console.log("Dados do médico:",medico);const editor=document.getElementById('editor');const laudo=editor?editor.innerHTML:'';console.log("Conteúdo do editor recuperado");if(!laudo){throw new Error('O conteúdo do laudo não pode estar vazio');}
const dadosLaudo={paciente,medidas,calculos,medico,laudo};fetch('/gerar_doc',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFToken()},body:JSON.stringify(dadosLaudo)}).then(response=>{if(!response.ok){throw new Error('Erro ao gerar documento DOC');}
return response.blob();}).then(blob=>{const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`Laudo_${paciente.nome.trim().replace(/[^a-zA-Z0-9]/g,'_')}.docx`;document.body.appendChild(a);a.click();window.URL.revokeObjectURL(url);a.remove();}).catch(error=>{console.error('Erro ao gerar DOC:',error);alert('Erro ao gerar o documento DOC. Por favor, tente novamente.');});}catch(error){console.error('Erro ao preparar dados:',error);alert('Erro ao gerar o DOC. Por favor, verifique os dados e tente novamente.');}}
function getCSRFToken(){const element=document.querySelector('meta[name="csrf-token"]');if(!element){console.error('CSRF token meta tag não encontrada');return'';}
return element.getAttribute('content');}