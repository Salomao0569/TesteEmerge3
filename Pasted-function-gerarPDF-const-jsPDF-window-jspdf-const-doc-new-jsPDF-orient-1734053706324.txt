function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });

    const pageWidth = doc.internal.pageSize.width;
    const margin = 20;
    const contentWidth = pageWidth - (2 * margin);

    // Título do documento
    doc.setFontSize(16);
    doc.text("Laudo de Ecodopplercardiograma", margin, margin);

    // Dados do paciente
    const dadosPaciente = [
        ["Nome", document.getElementById('nome').value || 'N/D'],
        ["Data Nascimento", document.getElementById('dataNascimento').value || 'N/D'],
        ["Sexo", document.getElementById('sexo').value || 'N/D'],
        ["Peso", (document.getElementById('peso').value ? document.getElementById('peso').value + " kg" : 'N/D')],
        ["Altura", (document.getElementById('altura').value ? document.getElementById('altura').value + " cm" : 'N/D')],
        ["Superfície Corpórea", (document.getElementById('superficie').value ? document.getElementById('superficie').value + " m²" : 'N/D')]
    ];

    doc.autoTable({
        startY: margin + 10,
        head: [['Dados do Paciente', 'Valor']],
        body: dadosPaciente,
        theme: 'grid',
        styles: { fontSize: 10 },
        margin: { left: margin }
    });

    // Tabela de Medidas e Cálculos
    const medidasCalculos = [
        ["Medida", "Valor", "Un", "Cálculo", "Valor", "Un"],
        ["Aorta", document.getElementById('aorta').value, "mm", "Volume Diastólico Final", document.getElementById('print_volume_diast_final').textContent, "ml"],
        ["Aorta Ascendente", document.getElementById('aorta_asc').value, "mm", "Volume Sistólico", document.getElementById('print_volume_sistolico').textContent, "ml"],
        ["Átrio Esquerdo", document.getElementById('atrio').value, "mm", "Massa do VE", document.getElementById('print_massa_ve').textContent, "g"],
        ["Vol Atrial Esq. Indexado", document.getElementById('vol_atrial_index').value, "", "Volume Ejetado", document.getElementById('print_volume_ejetado').textContent, "ml"],
        ["Diâmetro Diastólico", document.getElementById('diam_diast_final').value, "mm", "Fração de Ejeção", document.getElementById('print_fracao_ejecao').textContent, "%"],
        ["Diâmetro Sistólico", document.getElementById('diam_sist_final').value, "mm", "Percentual Enc. Cavidade", document.getElementById('print_percent_encurt').textContent, "%"],
        ["Espessura do Septo", document.getElementById('esp_diast_septo').value, "mm", "Espessura Relativa Parede", document.getElementById('print_esp_relativa').textContent, ""],
        ["Espessura da Parede", document.getElementById('esp_diast_ppve').value, "mm", "Índice de massa", document.getElementById('print_indice_massa').textContent, "g/m²"]
    ];

    doc.autoTable({
        startY: doc.autoTable.previous.finalY + 10,
        head: [["Cálculos e Medidas"]],
        body: medidasCalculos,
        theme: 'grid',
        styles: { 
            fontSize: 9,
            cellPadding: 2,
            overflow: 'linebreak',
            halign: 'left'
        },
        columnStyles: {
            0: { cellWidth: 35 },
            1: { cellWidth: 20, halign: 'right' },
            2: { cellWidth: 15 },
            3: { cellWidth: 35 },
            4: { cellWidth: 20, halign: 'right' },
            5: { cellWidth: 15 }
        },
        margin: { left: margin },
        headStyles: {
            fillColor: [74, 144, 226],
            textColor: 255,
            fontSize: 11
        }
    });

    // Laudo
    const laudoContent = document.getElementById('editor').innerText;
    const textLines = doc.splitTextToSize(laudoContent, contentWidth);
    
    if (doc.autoTable.previous.finalY + (textLines.length * 5) > doc.internal.pageSize.height - margin) {
        doc.addPage();
        doc.autoTable.previous.finalY = margin;
    }

    doc.setFontSize(11);
    textLines.forEach((line, index) => {
        const yPos = doc.autoTable.previous.finalY + 10 + (index * 5);
        if (yPos > doc.internal.pageSize.height - margin) {
            doc.addPage();
            doc.autoTable.previous.finalY = margin;
            doc.text(line, margin, margin + ((index % 20) * 5));
        } else {
            doc.text(line, margin, yPos);
        }
    });

    // Numeração das páginas
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.text(`Página ${i} de ${totalPages}`, pageWidth - margin, doc.internal.pageSize.height - 10, { align: 'right' });
    }

    doc.save("laudo_ecocardiograma.pdf");
}